SELECT
  user_pseudo_id,
  landing_page,
  SAFE_DIVIDE(
    SUM(end_time-start_time) / 1000000,
    COUNT(DISTINCT session_id)
  ) AS average_session_duration,
  SAFE_DIVIDE(
    SUM(event_count_without_session_start),
    COUNT(DISTINCT session_id)
  ) AS events_per_session
FROM
  (
    SELECT
      user_pseudo_id,
      MAX(
        (
          SELECT
            value.string_value
          FROM
            UNNEST (event_params)
          WHERE
            event_name = 'session_start'
            AND key = 'page_location'
        )
      ) AS landing_page,
      CONCAT(
        user_pseudo_id,
        (
          SELECT
            value.int_value
          FROM
            UNNEST (event_params)
          WHERE
            key = 'ga_session_id'
        )
      ) AS session_id,
      MIN(event_timestamp) AS start_time,
      MAX(event_timestamp) AS end_time,
      COUNTIF(event_name NOT IN ('session_start')) AS event_count_without_session_start
    FROM
      `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`
    WHERE
      _TABLE_SUFFIX BETWEEN '20201201' AND '20201231'
    GROUP BY
      user_pseudo_id,
      session_id
  )
GROUP BY
  user_pseudo_id,
  landing_page